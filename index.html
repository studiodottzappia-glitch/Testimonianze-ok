<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ci racconti la tua esperienza?</title>
  <meta name="description" content="Condividi la tua esperienza allo Studio Dentistico Zappia. Le tue parole aiutano altre persone a scegliere con serenit√†.">
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#2563eb; --accent-ink:#fff; --ring: rgba(37,99,235,.35);
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --shadow: 0 10px 25px rgba(0,0,0,.08); --radius:20px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--ink); background:var(--bg); line-height:1.5;}
    .wrap{max-width:1100px; margin:0 auto; padding:24px;}
    header{display:flex; gap:18px; align-items:center; margin:8px 0 20px}
    .brand{font-weight:700; letter-spacing:.2px; font-size:1.1rem}
    .badge{font-size:.72rem; color:var(--muted)}
    .layout{display:grid; grid-template-columns: 320px 1fr; gap:24px; align-items:flex-start}
    @media (max-width: 1100px){.layout{grid-template-columns: 1fr}.guide{position:static; top:auto}}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow)}
    .hero{padding:28px}
    h1{font-size:clamp(1.4rem, 1.2rem + 1.2vw, 2rem); margin:0 0 12px}
    p{margin:0 0 12px}
    .muted{color:var(--muted)}
    .guide{position:sticky; top:16px; padding:20px}
    .guide h3{margin:0 0 8px; font-size:1rem}
    .guide ol{margin:8px 0 0 20px}
    .guide li{margin:8px 0}
    .hint{font-size:.86rem; color:var(--muted)}
    form{padding:20px}
    label{display:block; font-weight:600; margin:10px 0 6px}
    textarea, input[type="text"], input[type="email"], select{
      width:100%; border:1px solid #e5e7eb; background:#fff; color:var(--ink);
      border-radius:14px; padding:12px 14px; outline:0; resize:vertical; min-height:auto; transition: box-shadow .2s, border-color .2s;
      font-size:1rem; line-height:1.6;
    }
    textarea{min-height:200px; padding-bottom:36px}
    textarea:focus, input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width: 700px){ .row{grid-template-columns:1fr} }
    .counter{position:relative; display:block; margin-top:6px; font-size:.8rem; color:var(--muted)}
    .counter .len{font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1;}
    .agree{display:flex; gap:10px; align-items:flex-start; margin:10px 0 0}
    .agree input{width:20px; height:20px; margin-top:3px}
    .cta{display:flex; flex-wrap:wrap; gap:10px; margin-top:18px}
    .btn{appearance:none; border:0; background:var(--accent); color:var(--accent-ink); border-radius:14px; padding:12px 16px; font-weight:700; cursor:pointer; transition: transform .02s, filter .15s}
    .btn.secondary{background:#111827; color:#fff}
    .btn.ghost{background:#eef2ff; color:#3730a3}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .legal{font-size:.86rem; color:var(--muted); margin-top:6px}
    footer{padding:24px; text-align:center; font-size:.85rem; color:var(--muted)}
    .success{display:none; padding:24px}
    .success.active{display:block}
    .hide-on-success.active{display:none}
    .pill{display:inline-flex; gap:6px; align-items:center; border-radius:999px; padding:6px 10px; background:#eef2ff; color:#3730a3; font-size:.8rem; font-weight:600}
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:8px}
    .copybox{font-size:.85rem; color:var(--muted)}
    .toast{position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition: .3s}
    .toast.show{opacity:1; transform:translateY(0)}
    a{color:var(--accent)}
    .guide.floating{position:fixed; left:16px; top:50%; transform:translateY(-50%); width:320px; z-index:50; max-height:82vh; overflow:auto}
    @media (max-width: 1100px){ .guide.floating{left:8px; right:8px; top:8px; transform:none; width:auto; max-height:unset} }

    /* PATCH TECNICHE */
    .layout > *{ min-width:0; }
    @media (max-width: 1100px){ .layout{ grid-template-columns: 1fr; } .guide{ position:static; top:auto; } }
    @media (max-width: 900px){ .guide, .guide.floating{ position:static !important; top:auto !important; left:auto !important; right:auto !important; transform:none !important; width:auto !important; max-height:none !important; z-index:auto !important; } }

/* === Modale Privacy Policy (aggiornata con scroll) === */
.modal {
  display: none; /* nascosta di default */
  position: fixed;
  z-index: 999; /* sopra tutto */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6); /* sfondo scuro */
  overflow-y: auto; /* scroll verticale se il contenuto √® alto */
  padding: 20px; /* spazio tra bordo e contenuto */
}

.modal-content {
  background: #fff;
  margin: 40px auto; /* margine sopra e sotto */
  padding: 20px;
  width: 90%;
  max-width: 500px;
  border-radius: 12px;
  position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  font-family: inherit;
  max-height: calc(100vh - 80px); /* la finestra non supera l'altezza schermo */
  overflow-y: auto; /* scroll solo dentro la finestra bianca */
}

.close {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 24px;
  font-weight: bold;
  color: #333;
  cursor: pointer;
}

.close:hover {
  color: #000;
}

.privacy-link {
  text-decoration: underline;
  cursor: pointer;
}

/* === Pannello guida mobile flottante (solo mobile) === */
@media (max-width: 700px){
  .helper-fab{
    position: fixed; right: 16px; bottom: 16px;
    width: 52px; height: 52px; border-radius: 999px;
    display: flex; align-items: center; justify-content: center;
    background: var(--accent); color: var(--accent-ink);
    font-weight: 800; font-size: 22px; line-height: 1;
    box-shadow: var(--shadow); cursor: pointer; z-index: 960;
    user-select: none;
  }
  .helper-fab:active{ transform: translateY(1px); }

  .helper-panel{
    position: fixed; right: 12px; left: 12px; bottom: 12px;
    max-width: 480px; margin: 0 auto;
    background: #fff; color: var(--ink);
    border-radius: 18px; box-shadow: var(--shadow);
    transform: translateY(12px); opacity: 0; pointer-events: none;
    transition: .18s ease; z-index: 950;
    display: flex; flex-direction: column; max-height: 60vh;
    border: 1px solid #e5e7eb;
  }
  .helper-panel.open{ transform: translateY(0); opacity: 1; pointer-events: auto; }

  .helper-head{
    position: sticky; top: 0; z-index: 1;
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 14px; border-bottom: 1px solid #eef2ff;
    background: #fff; border-top-left-radius: 18px; border-top-right-radius: 18px;
    font-weight: 700;
  }
  .helper-close{
    appearance: none; border: 0; background: transparent; cursor: pointer;
    font-size: 22px; line-height: 1; padding: 6px; color: var(--muted);
  }
  .helper-body{
    padding: 12px 14px; overflow-y: auto; -webkit-overflow-scrolling: touch;
    font-size: .95rem;
  }
  .helper-body ol{ margin: 0 0 6px 18px; }
  .helper-hint{ font-size: .85rem; color: var(--muted); margin-top: 6px; }
}
/* Nasconde il pannello/flottante su schermi pi√π larghi: desktop resta invariato */
@media (min-width: 701px){
  .helper-fab, .helper-panel{ display: none !important; }
}

/* Mostra messaggi diversi in base al dispositivo */
@media (max-width: 700px) {
  .desktop-only { display: none; }
  .mobile-only { display: block; }
}
@media (min-width: 701px) {
  .desktop-only { display: block; }
  .mobile-only { display: none; }
}


  </style>
</head>
<body>
  <script>window.dataLayer = window.dataLayer || [];</script>
  <div class="wrap">
    <header>
      <img src="logo-zappia.png" alt="Logo Studio Dentistico Zappia" width="140" style="max-height:64px; object-fit:contain; box-shadow:var(--shadow); background:#16162f; border-radius:12px; padding:4px">
      <div>
        <div class="brand">Studio Dentistico Zappia</div>
        <div class="badge">Genova Pontedecimo</div>
      </div>
    </header>

    <div class="layout" id="layout">
      <!-- GUIDA DOMANDE -->
      <aside class="card guide" id="guide">
        <div class="pill">Guida rapida</div>
        <h3>Raccontaci la tua esperienza</h3>
        <p class="hint desktop-only">Puoi seguire questa traccia: la trovi sempre nella colonna a sinistra.</p>
<p class="hint mobile-only">Tocca il ‚Äú?‚Äù in basso a destra per aprire i suggerimenti mentre scrivi.</p>

        <ol>
          <li>Quali erano i problemi relativi alla salute dei tuoi denti?</li>
          <li>Quali erano le principali paure che avevi dal dentista? Sei riuscito a superarle grazie al nostro modo di lavorare?</li>
          <li>Come ti sei trovato nel nostro studio? Sei rimasto soddisfatto del risultato ottenuto e dei miglioramenti ottenuti?</li>
          <li>Consiglieresti ad altri famigliari/amici/colleghi di rivolgersi a noi per la cura del suo sorriso e quello dei suoi cari?</li>
        </ol>
        <p class="hint">Suggerimento: scrivi come parleresti ad un amico üòä</p>
      </aside>

      <main id="main">
        <section class="card hero hide-on-success" id="intro">
          <h1>Ci racconti la tua esperienza?</h1>
          <p>Per noi √® sempre molto importante fare in modo che ognuno dei nostri pazienti sia soddisfatto delle cure ricevute.</p>
          <p>Ma non solo. Lavoriamo ogni giorno per far si che "la visita dal dentista" non sia pi√π quello spauracchio che spesso fa tremare anche noi adulti, ma un momento sereno e senza timori.</p>
          <p>Innanzi tutto, quindi, ti ringrazio per la fiducia che ci hai dato.</p>
          <p>E visto che ormai ci conosciamo da un po' di tempo, ci piacerebbe molto ricevere una tua testimonianza sul lavoro fatto fin'ora.</p>
          <p>Per comodit√†, qui accanto trovi qualche domanda che puoi utilizzare come traccia da seguire per raccontarci la tua esperienza.</p>
          <p>Ti ringrazio in anticipo se vorrai dedicarci qualche minuto per lasciarci la tua opinione.</p>

          <div class="cta" style="margin-top:18px">
            <button class="btn" id="chooseAssist" type="button">Voglio una mano (consigliato)</button>
            <button class="btn ghost" id="chooseManual" type="button">Scrivo liberamente</button>
          </div>
        </section>

        <!-- FLOW ASSISTITO -->
        <section class="card hide-on-success" id="assistFlow" style="display:none;">
          <form id="assistForm" style="padding:20px">
            <div class="row">
              <div>
                <label for="nome2">Il tuo nome</label>
                <input type="text" id="nome2" placeholder="Es. Maria R." required>
              </div>
              <div>
                <label for="email2">Email (solo per eventuali chiarimenti ‚Äì non verr√† pubblicata)</label>
                <input type="email" id="email2" placeholder="esempio@mail.com">
              </div>
            </div>

            <label for="aq1">1) Quali erano i problemi relativi alla salute dei tuoi denti?</label>
            <textarea id="aq1" placeholder="Es. gengive che sanguinavano, sensibilit√† al freddo..."></textarea>

            <label for="aq2">2) Quali erano le principali paure che avevi dal dentista? Sei riuscito a superarle grazie al nostro modo di lavorare?</label>
            <textarea id="aq2" placeholder="Es. ansia, paura del dolore; spiegazioni chiare mi hanno tranquillizzato..."></textarea>

            <label for="aq3">3) Come ti sei trovato nel nostro studio? Sei rimasto soddisfatto del risultato ottenuto e dei miglioramenti ottenuti?</label>
            <textarea id="aq3" placeholder="Es. ambiente sereno, personale gentile, risultati soddisfacenti..."></textarea>

            <label for="aq4">4) Consiglieresti ad altri famigliari/amici/colleghi di rivolgersi a noi per la cura del suo sorriso e quello dei suoi cari?</label>
            <textarea id="aq4" placeholder="Es. s√¨, lo consiglierei a chi ha timore del dentista perch√©..."></textarea>

            <div class="cta">
              <button class="btn" id="draftBtn" type="button">Verifica la tua bozza</button>
              <button class="btn ghost" id="clearAssist" type="button">Pulisci</button>
            </div>

            <div class="preview" id="assistPreview" style="display:none">
              <h3>Anteprima modificabile</h3>
              <p class="note">Se qualcosa non ti rappresenta, modifica liberamente prima di approvare. Tu sei l'autore del testo.</p>
              <textarea id="assistDraft" style="min-height:220px"></textarea>

              <div class="agree">
                <input id="consenso2" type="checkbox">
                <label for="consenso2" style="font-weight:500">Autorizzo lo Studio Dentistico Zappia a utilizzare la mia testimonianza (anche parziale) all‚Äôinterno di materiali informativi e sul sito, ai sensi della normativa vigente.</label>
              </div>
              <!-- Sezione link alla Privacy Policy -->
<div class="legal">
  Vedi la nostra 
  <a id="privacyLink2" href="#" class="privacy-link">Privacy Policy</a>.
</div>


              <div class="toolbar">
                <div class="copybox">Invia via email o copia il testo approvato.</div>
                <div class="cta">
                  <button class="btn" id="sendAssistMail" type="button">Invia via Email</button>
                  <button class="btn secondary" id="copyAssistDraft" type="button">Copia il testo</button>
                </div>
              </div>
            </div>
          </form>
        </section>

        <!-- FLOW LIBERO -->
        <section class="card hide-on-success" id="manualFlow" style="display:none;">
          <form id="manualForm" style="padding:20px">
            <div class="row">
              <div>
                <label for="nome">Il tuo nome</label>
                <input type="text" id="nome" name="nome" placeholder="Es. Maria R." required>
              </div>
              <div>
                <label for="email">Email (solo per eventuali chiarimenti ‚Äì non verr√† pubblicata)</label>
                <input type="email" id="email" name="email" placeholder="esempio@mail.com">
              </div>
            </div>

            <label for="freeText">Scrivi liberamente la tua testimonianza</label>
            <textarea id="freeText" placeholder="Raccontaci la tua esperienza, anche in poche righe. La guida a sinistra pu√≤ aiutarti."></textarea>
            <span class="counter">Lunghezza: <span class="len" data-for="freeText">0</span> caratteri</span>

            <div class="agree">
              <input id="consenso" type="checkbox" required>
              <label for="consenso" style="font-weight:500">Autorizzo lo Studio Dentistico Zappia a utilizzare la mia testimonianza (anche parziale) all‚Äôinterno di materiali informativi e sul sito, ai sensi della normativa vigente.</label>
            </div>
            <div class="legal">Vedi la nostra
  <a id="privacyLink1" href="#" class="privacy-link">Privacy Policy</a>.
</div>

            <div class="toolbar">
              <div class="copybox">Puoi prima revisionare il testo e poi inviare.</div>
              <div class="cta">
                <button class="btn" id="reviseBtn" type="button">Revisiona</button>
                <button class="btn" id="makeEmail" type="button">Invia via Email</button>
                <button class="btn secondary" id="copyText" type="button">Copia il testo</button>
              </div>
            </div>
          </form>

          <footer>¬© <span id="year"></span> Studio Dentistico Zappia ‚Äì Genova Pontedecimo</footer>
        </section>

        <section class="card success" id="success">
          <h2>Grazie! üéâ</h2>
          <p>La tua testimonianza √® pronta. Puoi <a id="mailtoLink" href="#">inviarla via email</a> oppure condividerla come preferisci.</p>
        </section>
      </main>
    </div>
  </div>

  <div class="toast" id="toast">Copiato negli appunti ‚úÖ</div>

  <script>
    /* ====== CONFIG ====== */
    const WEBHOOK_URL = 'https://hook.eu2.make.com/q7a9tq9snbwpcutra8lkw4ynkf6vt53p';
    const DEST_EMAIL  = 'studio.dott.zappia@gmail.com';
    const PRIVACY_URL = '#';
    const CONSENT_LINE = 'Dichiaro di autorizzare lo Studio Dentistico Zappia a utilizzare la mia testimonianza (anche parziale) all\'interno di materiali informativi e sul sito, ai sensi della normativa vigente.';

    /* ====== UTILS ====== */
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function dl(x){ window.dataLayer = window.dataLayer || []; window.dataLayer.push(x); }
    function esc(s){ return encodeURIComponent(s); }
    async function postJSON(url, payload){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      let data = null;
      try{
        if(ct.includes('application/json')){
          data = await r.json();
        } else {
          const txt = await r.text();
          data = { text: txt };
        }
      }catch(e){
        try { data = { text: await r.text() }; } catch(_) { data = { text: '' }; }
      }
      if(!r.ok){ throw new Error('HTTP '+r.status+' '+(data ? JSON.stringify(data).slice(0,200) : '')); }
      return data;
    }

    /* ====== INIT ====== */
    $('#privacyLink1') && ($('#privacyLink1').href = PRIVACY_URL);
    $('#privacyLink2') && ($('#privacyLink2').href = PRIVACY_URL);
    $('#year') && ($('#year').textContent = new Date().getFullYear());

    // Counter lunghezza
    $$('.counter .len').forEach(c => {
      const id = c.getAttribute('data-for');
      const el = document.getElementById(id);
      const update = () => c.textContent = (el?.value || '').length;
      el?.addEventListener('input', update); update();
    });

    /* ====== SWITCH MODALIT√Ä ====== */
    const guide = $('#guide');
    const assistFlow = $('#assistFlow');
    const manualFlow = $('#manualFlow');

    $('#chooseAssist')?.addEventListener('click', ()=>{
      assistFlow.style.display='block';
      manualFlow.style.display='none';
      guide?.classList.remove('floating');
      dl({event:'mode_assist'});
      window.scrollTo({top:0,behavior:'smooth'});
    });
    $('#chooseManual')?.addEventListener('click', ()=>{
      assistFlow.style.display='none';
      manualFlow.style.display='block';
      guide?.classList.remove('floating');
      dl({event:'mode_manual'});
      window.scrollTo({top:0,behavior:'smooth'});
    });

    /* ====== ASSISTITO: GENERAZIONE ====== */
    function buildRiassuntoFromAssist(){
      const nome = $('#nome2')?.value.trim() || '';
      const q1 = $('#aq1')?.value.trim() || '';
      const q2 = $('#aq2')?.value.trim() || '';
      const q3 = $('#aq3')?.value.trim() || '';
      const q4 = $('#aq4')?.value.trim() || '';
      const lines = [];
      if (nome) lines.push(`nome: ${nome}`);
      if (q1)   lines.push(`problemi: ${q1}`);
      if (q2)   lines.push(`paure: ${q2}`);
      if (q3)   lines.push(`esperienza: ${q3}`);
      if (q4)   lines.push(`consiglio: ${q4}`);
      return lines.join('\n');
    }

    function synthLocalDraft(p){
      const A = p.answers; const nome = p.nome;
      const intro   = 'Voglio raccontare in poche righe la mia esperienza allo Studio Dentistico Zappia.';
      const b1 = A.problemi  ? `Prima di arrivare allo Studio Zappia avevo ${A.problemi}.` : '';
      const b2 = A.paure     ? `Confesso che ${A.paure}.` : '';
      const b3 = A.esperienza? `In studio ho trovato un ambiente attento e professionale: ${A.esperienza}.` : '';
      const b4 = A.consiglio ? `Per questo consiglio lo Studio a chi cerca un approccio chiaro e gentile: ${A.consiglio}.` : '';
      const outro   = 'Spero che la mia esperienza possa essere utile a chi sta cercando di affrontare la visita con pi√π serenit√†.';
      let text = [intro, b1, b2, b3, b4, outro].filter(Boolean).join(' ');
      text = text.replace(/\s+/g,' ').trim();
      if(nome) text += `\n\n‚Äî ${nome}`;
      return text || 'Scrivi qualche riga nei campi qui sopra e poi clicca su "Verifica la tua bozza".';
    }

    function showAssistPreview(){
  $('#assistPreview').style.display='block';
  const c = $('#consenso2');
  if (c) { c.required = true; }         // <- aggiunge required ora che √® visibile
  window.scrollTo({top: $('#assistPreview').offsetTop - 20, behavior:'smooth'});
}


    async function generateAssist(){
      if(!$('#assistForm').reportValidity()) return;
      const btn = $('#draftBtn');
      const prev = btn.textContent; btn.textContent = 'Sto preparando la bozza‚Ä¶'; btn.disabled = true;
      dl({event:'assist_generate_attempt'});

      const riassunto = buildRiassuntoFromAssist();

      // 1) tenta Make (AI)
      try{
        const res = await postJSON(WEBHOOK_URL, { testo: riassunto });
        let out = '';
        if(res){
          // normalizza possibili chiavi usate nello scenario Make
          out = res.text || res.output || res.result || res.message || (typeof res === 'string' ? res : '');
        }
        if (out && typeof out === 'string'){
          $('#assistDraft').value = out.trim();
          showAssistPreview();
          btn.textContent = prev; btn.disabled = false;
          return;
        }
      }catch(e){ console.warn('Make webhook error or non-JSON response:', e); }

      // 2) fallback locale
      const payload = {
        nome:  $('#nome2')?.value.trim() || '',
        email: $('#email2')?.value.trim() || '',
        answers: {
          problemi:   $('#aq1')?.value.trim() || '',
          paure:      $('#aq2')?.value.trim() || '',
          esperienza: $('#aq3')?.value.trim() || '',
          consiglio:  $('#aq4')?.value.trim() || ''
        },
        mode:'generate'
      };
      $('#assistDraft').value = synthLocalDraft(payload);
      dl({event:'assist_local_fallback'});
      showAssistPreview();
      btn.textContent = prev; btn.disabled = false;
    }

    $('#draftBtn')?.addEventListener('click', generateAssist);

    // Pulisci
    $('#clearAssist')?.addEventListener('click', ()=>{
      ['aq1','aq2','aq3','aq4','assistDraft','nome2','email2'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
      const c = $('#consenso2'); if(c) c.checked=false;
      $('#assistPreview').style.display='none';
    });

    /* ====== ASSISTITO: COPY/EMAIL ====== */
    const toast = $('#toast');
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }

    $('#copyAssistDraft')?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText($('#assistDraft').value); showToast('Copiato negli appunti ‚úÖ'); dl({event:'assist_copy'}); }
      catch(e){ showToast('Impossibile copiare: seleziona e copia manualmente.'); }
    });

    function buildEmailBodyFromAssist(){
      const body = $('#assistDraft').value || '';
      const sign = '\n\n---\n' + CONSENT_LINE;
      return (body + sign).trim();
    }

   $('#sendAssistMail')?.addEventListener('click', async ()=>{
  if(!$('#assistForm').reportValidity()) return;
  if(!$('#consenso2').checked){ alert('Per favore, spunta la casella di autorizzazione.'); return; }

  const payload = {
    mode: 'assistito',
    nome:  $('#nome2')?.value.trim() || '',
    email: $('#email2')?.value.trim() || '',
    testo: ($('#assistDraft')?.value || '').trim(),
    consenso: true,
    ts: new Date().toISOString(),
    ua: navigator.userAgent,
    ref: location.href
  };

  try{
    await postJSON(WEBHOOK_URL, payload);       // invia a Make (Route B)
    $('#success').classList.add('active');      // UI ok (gi√† presente)
    $$('.hide-on-success').forEach(el=>el.classList.add('active'));
    window.scrollTo({top:0,behavior:'smooth'});
    dl({event:'assist_email_sent'});
  }catch(e){
    console.warn('Webhook Make fallito, uso mailto fallback:', e);
    const subject = 'La mia testimonianza per Studio Dentistico Zappia';
    const body = (payload.testo + '\n\n---\n' + CONSENT_LINE).trim();
    const href = `mailto:${esc(DEST_EMAIL)}?subject=${esc(subject)}&body=${esc(body)}`;
    const link = $('#mailtoLink'); link.href = href; link.click();

    $('#success').classList.add('active');
    $$('.hide-on-success').forEach(el=>el.classList.add('active'));
    window.scrollTo({top:0,behavior:'smooth'});
    dl({event:'assist_email_fallback'});
  }
});


    /* ====== LIBERA: REVISIONE + INVIO ====== */
    function buildManualText(){
      const nome = $('#nome')?.value.trim()||'';
      const testo = $('#freeText')?.value.trim()||'';
      const firma = nome ? `\n\n‚Äî ${nome}` : '';
      return (testo + firma).trim();
    }
    function synthLocalRevise(txt){
      let t = (txt||'').replace(/\s+/g,' ').trim();
      if(!t) return '';
      t = t.charAt(0).toUpperCase() + t.slice(1);
      if(!/[\.?!]$/.test(t)) t += '.';
      return t;
    }

    $('#reviseBtn')?.addEventListener('click', ()=>{
      if(!$('#manualForm').reportValidity()) return;
      const raw = $('#freeText').value;
      const revised = synthLocalRevise(raw);
      if(!revised){ alert('Scrivi qualcosa prima di revisionare.'); return; }
      const ok = confirm('Sostituire il testo con la versione revisionata?');
      if(ok){ $('#freeText').value = revised; showToast('Testo revisionato'); }
    });

    $('#copyText')?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(buildManualText()); showToast('Copiato negli appunti ‚úÖ'); dl({event:'manual_copy'}); }
      catch(e){ showToast('Impossibile copiare: seleziona e copia manualmente.'); }
    });

    function buildEmailBodyFromManual(){
      const body = buildManualText();
      const sign = '\n\n---\n' + CONSENT_LINE;
      return (body + sign).trim();
    }

    $('#makeEmail')?.addEventListener('click', async ()=>{
  if(!$('#manualForm').reportValidity()) return;
  if(!$('#consenso').checked){ alert('Per favore, spunta la casella di autorizzazione.'); return; }

  const nome  = $('#nome')?.value.trim() || '';
  const testo = ($('#freeText')?.value || '').trim();
  const payload = {
    mode: 'libero',
    nome,
    email: $('#email')?.value.trim() || '',
    testo: (testo + (nome ? `\n\n‚Äî ${nome}` : '')).trim(),
    consenso: true,
    ts: new Date().toISOString(),
    ua: navigator.userAgent,
    ref: location.href
  };

  try{
    await postJSON(WEBHOOK_URL, payload);       // invia a Make (Route B)
    $('#success').classList.add('active');      // UI ok (gi√† presente)
    $$('.hide-on-success').forEach(el=>el.classList.add('active'));
    window.scrollTo({top:0,behavior:'smooth'});
    dl({event:'manual_email_sent'});
  }catch(e){
    console.warn('Webhook Make fallito, uso mailto fallback:', e);
    const subject = 'La mia testimonianza per Studio Dentistico Zappia';
    const body = (payload.testo + '\n\n---\n' + CONSENT_LINE).trim();
    const href = `mailto:${esc(DEST_EMAIL)}?subject=${esc(subject)}&body=${esc(body)}`;
    const link = $('#mailtoLink'); link.href = href; link.click();

    $('#success').classList.add('active');
    $$('.hide-on-success').forEach(el=>el.classList.add('active'));
    window.scrollTo({top:0,behavior:'smooth'});
    dl({event:'manual_email_fallback'});
  }
});

  </script>

<!-- Modale Privacy Policy (unica, fuori dai flussi) -->
<div id="privacyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
  <div class="modal-content">
    <span class="close" aria-label="Chiudi">&times;</span>

    <h2 id="privacyTitle">Privacy Policy</h2>
    <p>
      Ai sensi del Regolamento (UE) 2016/679 (‚ÄúGDPR‚Äù), Studio Dentistico Zappia, con sede in Genova Pontedecimo, informa che i dati personali forniti dall‚Äôinteressato tramite il presente modulo saranno trattati in modo lecito, corretto e trasparente.
    </p>

    <h3>1. Finalit√† del trattamento</h3>
    <p>I dati saranno raccolti e trattati per le seguenti finalit√†:</p>
    <ul>
      <li>Gestione della richiesta di contatto e dell‚Äôappuntamento;</li>
      <li>Eventuale utilizzo della testimonianza fornita (anche parziale) su materiali informativi, siti web, social network e altre comunicazioni promozionali dello Studio, esclusivamente previo consenso dell‚Äôinteressato;</li>
      <li>Adempimenti di legge e obblighi fiscali connessi all‚Äôattivit√† sanitaria.</li>
    </ul>

    <h3>2. Modalit√† di trattamento</h3>
    <p>I dati saranno trattati con strumenti informatici e cartacei, adottando misure di sicurezza idonee a garantirne la riservatezza e l‚Äôintegrit√†.</p>

    <h3>3. Base giuridica</h3>
    <p>La base giuridica del trattamento √®:</p>
    <ul>
      <li>L‚Äôesecuzione di misure precontrattuali e contrattuali richieste dall‚Äôinteressato (prenotazione e gestione appuntamenti);</li>
      <li>Il consenso espresso per l‚Äôutilizzo della testimonianza a fini informativi e promozionali;</li>
      <li>L‚Äôadempimento di obblighi legali.</li>
    </ul>

    <h3>4. Conservazione dei dati</h3>
    <p>I dati saranno conservati per il tempo strettamente necessario alle finalit√† indicate e, nel caso di testimonianze, fino a eventuale revoca del consenso.</p>

    <h3>5. Comunicazione e diffusione</h3>
    <p>I dati non saranno diffusi, ma potranno essere comunicati a fornitori di servizi strettamente connessi alle finalit√† sopra indicate (es. hosting del sito, servizi cloud, software di gestione dello studio), che agiscono come Responsabili del Trattamento.</p>

    <h3>6. Diritti dell‚Äôinteressato</h3>
    <p>L‚Äôinteressato pu√≤ esercitare i diritti previsti dagli articoli 15-22 del GDPR, tra cui:</p>
    <ul>
      <li>Accesso ai propri dati personali;</li>
      <li>Rettifica o cancellazione degli stessi;</li>
      <li>Limitazione o opposizione al trattamento;</li>
      <li>Portabilit√† dei dati;</li>
      <li>Revoca del consenso in qualsiasi momento, senza pregiudicare la liceit√† del trattamento basata sul consenso prestato prima della revoca.</li>
    </ul>

    <h3>7. Titolare del trattamento</h3>
    <p>
      <strong>Studio Dentistico Zappia</strong><br>
      Via Felice del Canto 39R, Genova Pontedecimo (GE)<br>
      Email: <a href="mailto:info@studiodentisticozappia.it">info@studiodentisticozappia.it</a>
    </p>

    <h3>8. Reclamo</h3>
    <p>
      L‚Äôinteressato ha il diritto di proporre reclamo all‚ÄôAutorit√† Garante per la protezione dei dati personali
      (<a href="https://www.garanteprivacy.it" target="_blank" rel="noopener">www.garanteprivacy.it</a>).
    </p>
  </div>
</div>

<!-- Script: apre la stessa modale da entrambi i link (assistito e libero) -->
<script>
  (function () {
    const modal = document.getElementById("privacyModal");
    const closeBtn = modal.querySelector(".close");

    // intercetta #privacyLink1, #privacyLink2 e qualsiasi .privacy-link
    const privacyLinks = document.querySelectorAll("#privacyLink1, #privacyLink2, .privacy-link");

    privacyLinks.forEach(link => {
      // assicura che non apra nuove schede
      link.removeAttribute("target");
      link.removeAttribute("rel");

      link.addEventListener("click", function (e) {
        e.preventDefault();
        modal.style.display = "block";
        document.body.style.overflow = "hidden"; // blocca lo scroll sotto
      });
    });

    function closeModal() {
      modal.style.display = "none";
      document.body.style.overflow = ""; // ripristina scroll
    }

    closeBtn.addEventListener("click", closeModal);
    window.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modal.style.display === "block") closeModal(); });
  })();
</script>

<!-- Pannello guida mobile flottante -->
<div id="helperFab" class="helper-fab" aria-controls="helperPanel" aria-expanded="false" aria-label="Mostra traccia">?</div>

<div id="helperPanel" class="helper-panel" role="dialog" aria-modal="true" aria-labelledby="helperTitle" aria-hidden="true">
  <div class="helper-head">
    <span id="helperTitle">Traccia per la tua testimonianza</span>
    <button id="helperClose" class="helper-close" aria-label="Chiudi">&times;</button>
  </div>
  <div class="helper-body">
    <p class="helper-hint">Suggerimenti rapidi (puoi seguire liberamente):</p>
    <ol>
      <li>Qual era il problema o il disagio iniziale?</li>
      <li>Perch√© hai scelto lo Studio Zappia?</li>
      <li>Accoglienza e comunicazione: cosa ti ha colpito?</li>
      <li>Il trattamento: dolore, spiegazioni, tempi.</li>
      <li>Il risultato: cosa √® migliorato concretamente?</li>
      <li>Lo consiglieresti? A chi e perch√©?</li>
      <li>Un dettaglio personale che rende unica l‚Äôesperienza.</li>
    </ol>
    <p class="helper-hint">Chiudi questa finestra per continuare a scrivere.</p>
  </div>
</div>

<script>
(function(){
  const mq = window.matchMedia('(max-width: 700px)');
  const fab   = document.getElementById('helperFab');
  const panel = document.getElementById('helperPanel');
  const closeBtn = document.getElementById('helperClose');

  function openPanel(){
    panel.classList.add('open');
    panel.setAttribute('aria-hidden','false');
    fab.setAttribute('aria-expanded','true');
    // niente backdrop per non interferire con la tua Privacy Modal
    document.body.style.overflow = 'hidden';
  }
  function closePanel(){
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden','true');
    fab.setAttribute('aria-expanded','false');
    document.body.style.overflow = '';
  }

  function isManualVisible(){
    // visibilit√† reale della sezione ‚ÄúScrivo liberamente‚Äù
    const flow = document.getElementById('manualFlow');
    if(!flow) return false;
    const style = window.getComputedStyle(flow);
    return style.display !== 'none' && style.visibility !== 'hidden';
  }
  function updateFab(){
    const show = mq.matches && isManualVisible();
    fab.style.display = show ? 'flex' : 'none';
    if(!show) closePanel();
  }

  // Toggle in base ai bottoni che gi√† usi
  document.getElementById('chooseManual')?.addEventListener('click', ()=> setTimeout(updateFab, 50));
  document.getElementById('chooseAssist')?.addEventListener('click', ()=> setTimeout(updateFab, 50));

  // Apertura/chiusura
  fab.addEventListener('click', openPanel);
  closeBtn.addEventListener('click', closePanel);
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && panel.classList.contains('open')) closePanel(); });

  // Prima valutazione + resize
  updateFab();
  window.addEventListener('resize', updateFab);
})();
</script>

</body>
</html>


